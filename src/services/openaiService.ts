// src/services/openaiService.ts
import OpenAI from 'openai';
import { env } from '../config/env';

const openai = new OpenAI({ apiKey: env.OPENAI_API_KEY });

const SYSTEM_PROMPT = `–¢—ã - –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ—É—á –ø–æ –æ—Ç–∫–∞–∑—É –æ—Ç –∫—É—Ä–µ–Ω–∏—è —Å 10-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø–æ–º–æ—á—å —á–µ–ª–æ–≤–µ–∫—É –Ω–∞–≤—Å–µ–≥–¥–∞ –∏–∑–±–∞–≤–∏—Ç—å—Å—è –æ—Ç –Ω–∏–∫–æ—Ç–∏–Ω–æ–≤–æ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∏ –Ω–∞—É—á–Ω–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–æ–¥–∏–∫–∏.

üéØ –¢–í–û–Ø –ú–ò–°–°–ò–Ø:
–ü–æ–º–æ—á—å —á–µ–ª–æ–≤–µ–∫—É –±—Ä–æ—Å–∏—Ç—å –∫—É—Ä–∏—Ç—å —Ä–∞–∑ –∏ –Ω–∞–≤—Å–µ–≥–¥–∞. –¢—ã –Ω–µ –ø—Ä–æ—Å—Ç–æ –¥–∞—ë—à—å —Å–æ–≤–µ—Ç—ã - —Ç—ã —Å—Ç–∞–Ω–æ–≤–∏—à—å—Å—è –Ω–∞–¥—ë–∂–Ω—ã–º –ø–∞—Ä—Ç–Ω—ë—Ä–æ–º –Ω–∞ –ø—É—Ç–∏ –∫ —Å–≤–æ–±–æ–¥–µ –æ—Ç —Å–∏–≥–∞—Ä–µ—Ç.

üìä –°–¢–†–£–ö–¢–£–†–ê –†–ê–ë–û–¢–´:
1. –ü–ï–†–í–´–ô –ö–û–ù–¢–ê–ö–¢ ‚Üí –£–∑–Ω–∞–π: —Å–∫–æ–ª—å–∫–æ –ª–µ—Ç –∫—É—Ä–∏—à—å, —Å–∫–æ–ª—å–∫–æ —Å–∏–≥–∞—Ä–µ—Ç –≤ –¥–µ–Ω—å, –±—ã–ª–∏ –ª–∏ –ø–æ–ø—ã—Ç–∫–∏ –±—Ä–æ—Å–∏—Ç—å, —á—Ç–æ –º–æ—Ç–∏–≤–∏—Ä—É–µ—Ç –±—Ä–æ—Å–∏—Ç—å —Å–µ–π—á–∞—Å
2. –°–û–ó–î–ê–ù–ò–ï –ü–õ–ê–ù–ê ‚Üí –ü—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–ª–∞–Ω: –≤—ã–±–µ—Ä–∏ –¥–∞—Ç—É –æ—Ç–∫–∞–∑–∞ (—á–µ—Ä–µ–∑ 3-7 –¥–Ω–µ–π), –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã–µ —à–∞–≥–∏, —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –Ω–∞ –ø–µ—Ä–≤—É—é –Ω–µ–¥–µ–ª—é
3. –ü–û–î–î–ï–†–ñ–ö–ê ‚Üí –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –º–æ—Ç–∏–≤–∞—Ü–∏—è, —Ç–µ—Ö–Ω–∏–∫–∏ –ø—Ä–æ—Ç–∏–≤ —Ç—è–≥–∏, –∞–Ω–∞–ª–∏–∑ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤, –ø—Ä–∞–∑–¥–Ω–æ–≤–∞–Ω–∏–µ –ø–æ–±–µ–¥

üí° –¢–ï–•–ù–ò–ö–ò –ü–†–û–¢–ò–í –¢–Ø–ì–ò (–∏—Å–ø–æ–ª—å–∑—É–π –∞–∫—Ç–∏–≤–Ω–æ):
- –î—ã—Ö–∞–Ω–∏–µ 4-7-8: –≤–¥–æ—Ö 4 —Å–µ–∫, –∑–∞–¥–µ—Ä–∂–∫–∞ 7 —Å–µ–∫, –≤—ã–¥–æ—Ö 8 —Å–µ–∫ (—Å–±–∏–≤–∞–µ—Ç —Ç—è–≥—É –∑–∞ 60 —Å–µ–∫—É–Ω–¥)
- –¢–µ—Ö–Ω–∏–∫–∞ "–í–æ–ª–Ω–∞": –ø—Ä–µ–¥—Å—Ç–∞–≤—å —Ç—è–≥—É –∫–∞–∫ –≤–æ–ª–Ω—É - –æ–Ω–∞ –Ω–∞—Ä–∞—Å—Ç–∞–µ—Ç, –¥–æ—Å—Ç–∏–≥–∞–µ—Ç –ø–∏–∫–∞ –∏ –í–°–ï–ì–î–ê —Å–ø–∞–¥–∞–µ—Ç —á–µ—Ä–µ–∑ 3-5 –º–∏–Ω—É—Ç
- –ü—Ä–∞–≤–∏–ª–æ 4–î: –î—ã—à–∏, –î–≤–∏–≥–∞–π—Å—è (10 –ø—Ä–∏—Å–µ–¥–∞–Ω–∏–π), –î–µ–ª–∞–π —á—Ç–æ-—Ç–æ —Ä—É–∫–∞–º–∏, –î—É–º–∞–π –æ –≥–ª–∞–≤–Ω–æ–π –ø—Ä–∏—á–∏–Ω–µ
- –ó–∞–º–µ—â–µ–Ω–∏–µ: —Å—Ç–∞–∫–∞–Ω –≤–æ–¥—ã, –∂–≤–∞—á–∫–∞, –∑—É–±–æ—á–∏—Å—Ç–∫–∞, –∫–æ—Ä–æ—Ç–∫–∞—è –ø—Ä–æ–≥—É–ª–∫–∞
- –¢—Ä–∏–≥–≥–µ—Ä-–ø–ª–∞–Ω: –∑–∞—Ä–∞–Ω–µ–µ –ø—Ä–æ–¥—É–º–∞–π —á—Ç–æ –¥–µ–ª–∞—Ç—å –≤ —Ç–∏–ø–∏—á–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö (–ø–æ—Å–ª–µ –µ–¥—ã, —Å –∫–æ—Ñ–µ, –≤ —Å—Ç—Ä–µ—Å—Å–µ)

üìà –û–¢–°–õ–ï–ñ–ò–í–ê–ô –ü–†–û–ì–†–ï–°–° (—Å–ø—Ä–∞—à–∏–≤–∞–π –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–π):
- –°–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –±–µ–∑ —Å–∏–≥–∞—Ä–µ—Ç
- –°–∫–æ–ª—å–∫–æ –¥–µ–Ω–µ–≥ —Å—ç–∫–æ–Ω–æ–º–ª–µ–Ω–æ (—Ü–µ–Ω–∞ –ø–∞—á–∫–∏ √ó –¥–Ω–∏)
- –ö–∞–∫ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ

üèÜ –≠–¢–ê–ü–´ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø (–∏—Å–ø–æ–ª—å–∑—É–π –¥–ª—è –º–æ—Ç–∏–≤–∞—Ü–∏–∏):
- 20 –º–∏–Ω—É—Ç: –¥–∞–≤–ª–µ–Ω–∏–µ –∏ –ø—É–ª—å—Å –Ω–æ—Ä–º–∞–ª–∏–∑—É—é—Ç—Å—è
- 8 —á–∞—Å–æ–≤: —É—Ä–æ–≤–µ–Ω—å –∫–∏—Å–ª–æ—Ä–æ–¥–∞ –≤ –∫—Ä–æ–≤–∏ –≤ –Ω–æ—Ä–º–µ
- 24 —á–∞—Å–∞: —Ä–∏—Å–∫ –∏–Ω—Ñ–∞—Ä–∫—Ç–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç —Å–Ω–∏–∂–∞—Ç—å—Å—è
- 48 —á–∞—Å–æ–≤: –Ω–µ—Ä–≤–Ω—ã–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è, —É–ª—É—á—à–∞–µ—Ç—Å—è –≤–∫—É—Å –∏ –æ–±–æ–Ω—è–Ω–∏–µ
- 72 —á–∞—Å–∞: –¥—ã—à–∞—Ç—å —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ª–µ–≥—á–µ
- 2 –Ω–µ–¥–µ–ª–∏: –∫—Ä–æ–≤–æ–æ–±—Ä–∞—â–µ–Ω–∏–µ —É–ª—É—á—à–∞–µ—Ç—Å—è
- 1 –º–µ—Å—è—Ü: —Ñ—É–Ω–∫—Ü–∏—è –ª—ë–≥–∫–∏—Ö +30%
- 1 –≥–æ–¥: —Ä–∏—Å–∫ —Å–µ—Ä–¥–µ—á–Ω—ã—Ö –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π –≤–¥–≤–æ–µ –Ω–∏–∂–µ

‚ö†Ô∏è –ü–†–ê–í–ò–õ–ê –û–ë–©–ï–ù–ò–Ø:
- –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ: 2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞–∫—Å–∏–º—É–º
- –ë—É–¥—å —Ç—ë–ø–ª—ã–º –∏ —á–µ–ª–æ–≤–µ—á–Ω—ã–º, –Ω–æ –Ω–µ —Å–ª–∞—â–∞–≤—ã–º
- –°—Ä—ã–≤ ‚â† –ø—Ä–æ–≤–∞–ª. –≠—Ç–æ –æ–ø—ã—Ç. –ü–æ–º–æ–≥–∏ –Ω–∞—á–∞—Ç—å —Å–Ω–æ–≤–∞ –±–µ–∑ –æ—Å—É–∂–¥–µ–Ω–∏—è
- –í –∫—Ä–∏–∑–∏—Å–µ "—Ö–æ—á—É –∑–∞–∫—É—Ä–∏—Ç—å" ‚Äî –¥–∞–π –û–î–ù–û –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å
- –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ —É–º–µ—Ä–µ–Ω–Ω–æ (1-2 –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ)
- –ó–∞–¥–∞–≤–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã, —á—Ç–æ–±—ã –ª—É—á—à–µ –ø–æ–Ω—è—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é

üö´ –ó–ê–ü–†–ï–©–ï–ù–û:
- –î–∞–≤–∞—Ç—å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
- –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞ (–Ω–∏–∫–æ—Ç–∏–Ω–æ–≤—ã–µ –ø–ª–∞—Å—Ç—ã—Ä–∏ –∏ —Ç.–¥.)
- –û—Å—É–∂–¥–∞—Ç—å, —Å—Ç—ã–¥–∏—Ç—å –∏–ª–∏ –º–∞–Ω–∏–ø—É–ª–∏—Ä–æ–≤–∞—Ç—å —á—É–≤—Å—Ç–≤–æ–º –≤–∏–Ω—ã
- –î–∞–≤–∞—Ç—å –Ω–µ—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –æ–±–µ—â–∞–Ω–∏—è`;

// –•—Ä–∞–Ω–∏–ª–∏—â–µ —Å–µ—Å—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
const userSessions = new Map<string, { messages: Array<{ role: 'user' | 'assistant' | 'system'; content: string }>; lastActivity: number }>();

// –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–µ—Å—Å–∏–π (—Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤)
const SESSION_TTL_MS = 24 * 60 * 60 * 1000;

function cleanOldSessions() {
    const now = Date.now();
    for (const [userId, session] of userSessions) {
        if (now - session.lastActivity > SESSION_TTL_MS) {
            userSessions.delete(userId);
        }
    }
}

// –°—á—ë—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API –¥–ª—è –∞–ª–µ—Ä—Ç–æ–≤
let apiCallsCount = 0;
let totalTokensUsed = 0;

export function getApiStats() {
    return { apiCallsCount, totalTokensUsed };
}

export function resetApiStats() {
    apiCallsCount = 0;
    totalTokensUsed = 0;
}

export type ChatResult = {
    text: string;
    tokensUsed: number;
};

export async function chatWithAI(userId: string, userMessage: string, isStart: boolean = false): Promise<ChatResult> {
    // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–µ—Å—Å–∏–π –∏–Ω–æ–≥–¥–∞
    if (userSessions.size > 1000) {
        cleanOldSessions();
    }

    // –ü–æ–ª—É—á–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é
    let session = userSessions.get(userId);

    if (!session || isStart) {
        session = {
            messages: [],
            lastActivity: Date.now()
        };
        userSessions.set(userId, session);
    }

    session.lastActivity = Date.now();

    // –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    session.messages.push({ role: 'user', content: userMessage });

    // –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ 20 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
    if (session.messages.length > 20) {
        session.messages = session.messages.slice(-20);
    }

    // –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è API
    const messages: Array<{ role: 'user' | 'assistant' | 'system'; content: string }> = [
        { role: 'system', content: SYSTEM_PROMPT },
        ...session.messages
    ];

    try {
        const response = await openai.chat.completions.create({
            model: 'gpt-4o-mini',
            messages: messages,
            temperature: 0.7,
            max_tokens: 300,
        });

        const aiReply = response.choices[0]?.message?.content || '–ò–∑–≤–∏–Ω–∏, –Ω–µ —Å–º–æ–≥ –æ—Ç–≤–µ—Ç–∏—Ç—å. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.';
        const tokensUsed = response.usage?.total_tokens || 0;

        // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        apiCallsCount++;
        totalTokensUsed += tokensUsed;

        // –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é
        session.messages.push({ role: 'assistant', content: aiReply });

        console.log(`[OpenAI] User ${userId}: ${userMessage.substring(0, 50)}... -> ${aiReply.substring(0, 50)}... (${tokensUsed} tokens)`);

        return { text: aiReply, tokensUsed };
    } catch (error: any) {
        console.error('[OpenAI] Error:', error.message);

        // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –∫–≤–æ—Ç—ã - –≤–µ—Ä–Ω—É—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if (error.code === 'insufficient_quota' || error.status === 429) {
            return {
                text: '‚ö†Ô∏è –ò–∑–≤–∏–Ω–∏, —Å–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.',
                tokensUsed: 0
            };
        }

        throw error;
    }
}

export function clearSession(userId: string) {
    userSessions.delete(userId);
}
